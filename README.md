# Система анализа записей телефонных разговоров

Это полностью автономная система для транскрибации аудиозаписей и получения ответов на вопросы по их содержимому через Telegram-бота.

## Как это работает

Система состоит из двух основных сервисов:

1.  **Сервис мониторинга (`file_watcher.py`):** Этот сервис постоянно отслеживает указанную папку. При появлении в ней нового аудиофайла (`.m4a`), он автоматически:
    *   Транскрибирует аудио в текст с помощью `Whisper`.
    *   Разбивает текст на фрагменты и добавляет их в векторную базу знаний (`ChromaDB`).

2.  **Telegram-бот (`telegram_bot.py`):** Этот сервис предоставляет интерфейс для взаимодействия с системой. Вы можете задать ему вопрос, и он:
    *   Ищет наиболее релевантную информацию в базе знаний.
    *   Использует языковую модель `Llama` для генерации ответа на основе найденной информации.
    *   Присылает вам ответ со ссылками на исходные файлы разговоров.

---

## Установка и настройка

### Шаг 1: Системные зависимости (Debian/Ubuntu)

Сначала необходимо установить системные пакеты. Для этого выполните скрипт:

```bash
chmod +x setup_debian.sh
./setup_debian.sh
```

Этот скрипт установит `ffmpeg` (для работы с аудио), `pip` и `venv`.

### Шаг 2: Python-окружение

Рекомендуется использовать виртуальное окружение, чтобы изолировать зависимости проекта.

```bash
# Создаем виртуальное окружение в папке venv
python3 -m venv venv

# Активируем его
source venv/bin/activate

# Устанавливаем все необходимые Python-библиотеки
pip install -r requirements.txt
```

### Шаг 3: Конфигурация

Все настройки находятся в файле `src/config.py`. **Вам необходимо отредактировать этот файл перед запуском.**

1.  **`TELEGRAM_BOT_TOKEN`**: Вставьте сюда токен вашего Telegram-бота. Его можно получить у [@BotFather](https://t.me/BotFather).
2.  **`LLAMA_MODEL_PATH`**: Укажите **полный путь** к файлу языковой модели в формате GGUF.
    *   **Где взять модель?** Модели нужно скачивать отдельно. Хороший источник — [Hugging Face](https://huggingface.co/). Ищите модели в формате `GGUF`.
    *   Например, вы можете скачать модель [Llama-2-7B-Chat GGUF](https://huggingface.co/TheBloke/Llama-2-7B-Chat-GGUF/blob/main/llama-2-7b-chat.Q4_K_M.gguf) и положить ее в папку `/home/user/models/`.
    *   Тогда путь в конфиге будет: `LLAMA_MODEL_PATH = "/home/user/models/llama-2-7b-chat.Q4_K_M.gguf"`
3.  **`LLAMA_N_GPU_LAYERS`**: Если у вас есть видеокарта NVIDIA и вы хотите ее использовать, установите это значение больше 0 (например, 35). Для работы только на CPU оставьте значение `0`.
4.  Остальные пути (`AUDIO_FILES_PATH`, `DB_PATH` и т.д.) можно оставить по умолчанию.

---

## Запуск системы

Систему нужно запускать в виде двух отдельных сервисов. Рекомендуется использовать `tmux` или `screen`, чтобы они продолжали работать после закрытия терминала.

**1. Запуск сервиса мониторинга файлов:**

Откройте сессию `tmux` или `screen` и выполните команду из **корневой папки проекта**:

```bash
# Активируйте окружение, если еще не сделали этого
source venv/bin/activate

# Запускаем модуль как исполняемый
python -m src.file_watcher
```
Этот сервис начнет отслеживать папку `audio_files`. Оставьте его работать в фоновом режиме.

**2. Запуск Telegram-бота:**

Откройте **новую** сессию `tmux` или `screen` и выполните:

```bash
# Активируйте окружение
source venv/bin/activate

# Запускаем бота
python -m src.telegram_bot
```
Теперь ваш бот запущен и готов к работе.

---

## Использование

1.  Настройте ваш телефон или FTP-клиент так, чтобы он загружал записи разговоров в формате `.m4a` в папку `audio_files` на вашем сервере.
2.  Сервис мониторинга автоматически обнаружит, транскрибирует и проиндексирует файл. Вы увидите логи в его консоли.
3.  Откройте чат с вашим ботом в Telegram и задайте вопрос, касающийся содержания разговоров.

## Структура проекта

```
.
├── audio_files/        # Папка для исходных .m4a файлов
├── db/                 # Папка для хранения векторной базы данных
├── transcripts/        # Папка для сохранения текстовых расшифровок
├── src/                # Исходный код проекта
│   ├── __init__.py
│   ├── config.py       # Главный конфигурационный файл
│   ├── file_watcher.py # Сервис мониторинга файлов
│   ├── rag_core.py     # Ядро RAG-системы
│   ├── telegram_bot.py # Логика Telegram-бота
│   └── transcriber.py  # Модуль для транскрибации аудио
├── README.md           # Эта инструкция
├── requirements.txt    # Список Python-зависимостей
└── setup_debian.sh     # Скрипт установки системных пакетов
```
